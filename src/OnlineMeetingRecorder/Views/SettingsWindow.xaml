<Window x:Class="OnlineMeetingRecorder.Views.SettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:OnlineMeetingRecorder.ViewModels"
        xmlns:models="clr-namespace:OnlineMeetingRecorder.Models"
        xmlns:conv="clr-namespace:OnlineMeetingRecorder.Converters"
        Title="Totonoe - 設定"
        Height="740" Width="500"
        MinHeight="400" MinWidth="400"
        Background="{StaticResource WindowBgBrush}"
        FontFamily="{StaticResource PrimaryFont}"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResizeWithGrip"
        d:DataContext="{d:DesignInstance Type=vm:SettingsViewModel}"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d">

    <Window.Resources>
        <conv:EnumToBoolConverter x:Key="EnumBoolConverter"/>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
    </Window.Resources>

    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ヘッダー -->
        <TextBlock Grid.Row="0" Text="設定"
                   FontSize="28" FontWeight="SemiBold"
                   Foreground="{StaticResource TextPrimaryBrush}"
                   Margin="0,0,0,20"/>

        <!-- 設定項目（Dark Card コンテナ） -->
        <ScrollViewer Grid.Row="1" Style="{StaticResource DarkScrollViewer}"
                      VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <StackPanel>

                <!-- STTエンジン選択 -->
                <Border Style="{StaticResource DarkCard}">
                    <StackPanel>
                        <TextBlock Text="TRANSCRIPTION ENGINE"
                                   FontSize="11" FontWeight="SemiBold"
                                   Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                   Margin="0,0,0,12"/>
                        <RadioButton Style="{StaticResource DarkRadioButton}"
                                     Content="OpenAI Whisper API（クラウド）"
                                     IsChecked="{Binding SttEngine, Converter={StaticResource EnumBoolConverter}, ConverterParameter={x:Static models:SttEngine.Cloud}}"
                                     Margin="0,0,0,8"/>
                        <RadioButton Style="{StaticResource DarkRadioButton}"
                                     Content="Whisper.net（ローカル・オフライン）"
                                     IsChecked="{Binding SttEngine, Converter={StaticResource EnumBoolConverter}, ConverterParameter={x:Static models:SttEngine.Local}}"/>
                    </StackPanel>
                </Border>

                <!-- OpenAI API キー -->
                <Border Style="{StaticResource DarkCard}">
                    <StackPanel>
                        <TextBlock Text="OPENAI API KEY"
                                   FontSize="11" FontWeight="SemiBold"
                                   Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                   Margin="0,0,0,12"/>
                        <PasswordBox x:Name="ApiKeyBox" MaxLength="200"
                                     Style="{StaticResource DarkPasswordBox}"/>
                    </StackPanel>
                </Border>

                <!-- Whisper モデルパス -->
                <Border Style="{StaticResource DarkCard}">
                    <StackPanel>
                        <TextBlock Text="WHISPER MODEL FILE"
                                   FontSize="11" FontWeight="SemiBold"
                                   Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                   Margin="0,0,0,12"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0"
                                     Text="{Binding WhisperModelPath, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Margin="0,0,8,0"/>
                            <Button Grid.Column="1" Content="参照..."
                                    Command="{Binding BrowseModelFileCommand}"
                                    Style="{StaticResource SecondaryButton}"
                                    Height="36" Padding="16,0"/>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- 言語設定 -->
                <Border Style="{StaticResource DarkCard}">
                    <StackPanel>
                        <TextBlock Text="LANGUAGE"
                                   FontSize="11" FontWeight="SemiBold"
                                   Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                   Margin="0,0,0,12"/>
                        <TextBox Text="{Binding Language, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource DarkTextBox}"
                                 Width="80" HorizontalAlignment="Left"/>
                    </StackPanel>
                </Border>

                <!-- 音声エクスポートフォーマット -->
                <Border Style="{StaticResource DarkCard}">
                    <StackPanel>
                        <TextBlock Text="AUDIO EXPORT FORMAT"
                                   FontSize="11" FontWeight="SemiBold"
                                   Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                   Margin="0,0,0,12"/>
                        <RadioButton Style="{StaticResource DarkRadioButton}"
                                     Content="WAV（無変換・高品質）"
                                     IsChecked="{Binding AudioExportFormat, Converter={StaticResource EnumBoolConverter}, ConverterParameter={x:Static models:AudioExportFormat.Wav}}"
                                     Margin="0,0,0,8"/>
                        <RadioButton Style="{StaticResource DarkRadioButton}"
                                     Content="MP3（非可逆圧縮・小サイズ）"
                                     IsChecked="{Binding AudioExportFormat, Converter={StaticResource EnumBoolConverter}, ConverterParameter={x:Static models:AudioExportFormat.Mp3}}"
                                     Margin="0,0,0,8"/>
                        <RadioButton Style="{StaticResource DarkRadioButton}"
                                     Content="FLAC（可逆圧縮・高品質）"
                                     IsChecked="{Binding AudioExportFormat, Converter={StaticResource EnumBoolConverter}, ConverterParameter={x:Static models:AudioExportFormat.Flac}}"/>
                    </StackPanel>
                </Border>

                <!-- 議事録エンジン選択 -->
                <Border Style="{StaticResource DarkCard}">
                    <StackPanel>
                        <TextBlock Text="MINUTES ENGINE"
                                   FontSize="11" FontWeight="SemiBold"
                                   Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                   Margin="0,0,0,12"/>
                        <RadioButton Style="{StaticResource DarkRadioButton}"
                                     Content="テンプレート（発言録テーブル）"
                                     IsChecked="{Binding MinutesEngine, Converter={StaticResource EnumBoolConverter}, ConverterParameter={x:Static models:MinutesEngine.Template}}"
                                     Margin="0,0,0,8"/>
                        <RadioButton Style="{StaticResource DarkRadioButton}"
                                     Content="AI（OpenAI API）"
                                     IsChecked="{Binding MinutesEngine, Converter={StaticResource EnumBoolConverter}, ConverterParameter={x:Static models:MinutesEngine.CloudApi}}"
                                     Margin="0,0,0,8"/>
                        <RadioButton Style="{StaticResource DarkRadioButton}"
                                     Content="AI（ローカルLLM）"
                                     IsChecked="{Binding MinutesEngine, Converter={StaticResource EnumBoolConverter}, ConverterParameter={x:Static models:MinutesEngine.Llm}}"
                                     Visibility="{Binding IsLlmAvailable, Converter={StaticResource BoolToVisibility}}"/>

                        <!-- OpenAI APIモデル名 (CloudApi選択時のみ表示) -->
                        <StackPanel Margin="0,16,0,0">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding MinutesEngine}"
                                                     Value="{x:Static models:MinutesEngine.CloudApi}">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>

                            <TextBlock Text="OPENAI MODEL NAME"
                                       FontSize="11" FontWeight="SemiBold"
                                       Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                       Margin="0,0,0,8"/>
                            <TextBox Text="{Binding MinutesApiModel, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Width="200" HorizontalAlignment="Left"/>
                            <TextBlock Text="例: gpt-4o-mini, gpt-4.1-mini, gpt-5-nano"
                                       FontSize="10"
                                       Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                       Margin="0,4,0,0"/>
                        </StackPanel>

                        <!-- LLMモデルパス (Llm選択時のみ表示) -->
                        <StackPanel Margin="0,16,0,0">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding MinutesEngine}"
                                                     Value="{x:Static models:MinutesEngine.Llm}">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>

                            <TextBlock Text="LLM MODEL FILE (GGUF)"
                                       FontSize="11" FontWeight="SemiBold"
                                       Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                       Margin="0,0,0,8"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0"
                                         Text="{Binding LlmModelPath, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource DarkTextBox}"
                                         Margin="0,0,8,0"/>
                                <Button Grid.Column="1" Content="参照..."
                                        Command="{Binding BrowseLlmModelFileCommand}"
                                        Style="{StaticResource SecondaryButton}"
                                        Height="36" Padding="16,0"/>
                            </Grid>

                            <TextBlock Text="CONTEXT SIZE"
                                       FontSize="11" FontWeight="SemiBold"
                                       Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                       Margin="0,16,0,8"/>
                            <TextBox Text="{Binding LlmContextSize, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Width="120" HorizontalAlignment="Left"/>
                            <TextBlock Text="トークン数（既定: 8192、長い会議は 16384〜32768 推奨）"
                                       FontSize="10"
                                       Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                       Margin="0,4,0,0"/>

                            <TextBlock Text="GPU LAYER COUNT"
                                       FontSize="11" FontWeight="SemiBold"
                                       Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                       Margin="0,16,0,8"/>
                            <TextBox Text="{Binding LlmGpuLayerCount, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Width="120" HorizontalAlignment="Left"/>
                            <TextBlock Text="GPUにオフロードするレイヤー数（999=全レイヤー、0=CPUのみ）"
                                       FontSize="10"
                                       Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                       Margin="0,4,0,0"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- セッション保存先 -->
                <Border Style="{StaticResource DarkCard}">
                    <StackPanel>
                        <TextBlock Text="SESSION STORAGE"
                                   FontSize="11" FontWeight="SemiBold"
                                   Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                   Margin="0,0,0,12"/>
                        <TextBlock Text="空欄の場合: %LOCALAPPDATA%\OnlineMeetingRecorder\Sessions"
                                   FontSize="10"
                                   Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                   Margin="0,0,0,8"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0"
                                     Text="{Binding SessionStoragePath, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Margin="0,0,8,0"/>
                            <Button Grid.Column="1" Content="参照..."
                                    Command="{Binding BrowseSessionFolderCommand}"
                                    Style="{StaticResource SecondaryButton}"
                                    Height="36" Padding="16,0"/>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- 会議アプリ自動検知 -->
                <Border Style="{StaticResource DarkCard}">
                    <StackPanel>
                        <TextBlock Text="MEETING DETECTION"
                                   FontSize="11" FontWeight="SemiBold"
                                   Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                   Margin="0,0,0,12"/>
                        <CheckBox IsChecked="{Binding MeetingDetectionEnabled}"
                                  Cursor="Hand">
                            <CheckBox.Style>
                                <Style TargetType="CheckBox">
                                    <Setter Property="Foreground" Value="{StaticResource DarkCardTextBrush}"/>
                                    <Setter Property="FontFamily" Value="{StaticResource PrimaryFont}"/>
                                    <Setter Property="FontSize" Value="14"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="CheckBox">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <Border x:Name="CheckBorder"
                                                            Width="18" Height="18"
                                                            CornerRadius="3"
                                                            BorderThickness="2"
                                                            BorderBrush="{StaticResource DarkCardTextSecondaryBrush}"
                                                            Background="Transparent"
                                                            VerticalAlignment="Center"
                                                            Margin="0,0,10,0">
                                                        <TextBlock x:Name="CheckMark"
                                                                   Text="&#x2713;"
                                                                   FontSize="12" FontWeight="Bold"
                                                                   Foreground="{StaticResource AccentBrush}"
                                                                   HorizontalAlignment="Center"
                                                                   VerticalAlignment="Center"
                                                                   Visibility="Collapsed"/>
                                                    </Border>
                                                    <ContentPresenter Grid.Column="1"
                                                                      VerticalAlignment="Center"
                                                                      RecognizesAccessKey="True"/>
                                                </Grid>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsChecked" Value="True">
                                                        <Setter TargetName="CheckBorder" Property="BorderBrush"
                                                                Value="{StaticResource AccentBrush}"/>
                                                        <Setter TargetName="CheckMark" Property="Visibility"
                                                                Value="Visible"/>
                                                    </Trigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="CheckBorder" Property="BorderBrush"
                                                                Value="{StaticResource DarkCardTextBrush}"/>
                                                    </Trigger>
                                                    <MultiTrigger>
                                                        <MultiTrigger.Conditions>
                                                            <Condition Property="IsMouseOver" Value="True"/>
                                                            <Condition Property="IsChecked" Value="True"/>
                                                        </MultiTrigger.Conditions>
                                                        <Setter TargetName="CheckBorder" Property="BorderBrush"
                                                                Value="{StaticResource AccentHoverBrush}"/>
                                                    </MultiTrigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </CheckBox.Style>
                            会議アプリを検知して録音開始を通知する
                        </CheckBox>
                        <TextBlock Text="Zoom / Teams / Google Meet / Webex を自動検知します"
                                   FontSize="10"
                                   Foreground="{StaticResource DarkCardTextSecondaryBrush}"
                                   Margin="28,6,0,0"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- ボタンエリア -->
        <DockPanel Grid.Row="2" Margin="0,16,0,0">
            <TextBlock Text="{Binding StatusText}"
                       Foreground="{StaticResource TextSecondaryBrush}"
                       VerticalAlignment="Center" FontSize="12"/>
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Content="保存" Command="{Binding SaveCommand}"
                        Style="{StaticResource PrimaryButton}"
                        IsDefault="True" Margin="0,0,8,0" Width="100"/>
                <Button Content="閉じる" Click="CloseButton_Click"
                        Style="{StaticResource SecondaryButton}"
                        IsCancel="True" Width="100"/>
            </StackPanel>
        </DockPanel>
    </Grid>
</Window>
